# 魔裁 Memes 插件功能文档

## 概述

魔裁 Memes 是一个用于生成「魔法少女的魔法审判」表情包的 AstrBot 插件。该插件支持两种主要功能：安安说和审判表情包，让用户可以轻松创建风格独特的角色对话图片。

---

## 功能特性

### 1. 安安说

让安安举着写了你想说的话的素描本，支持多种表情选择。

#### 使用方法

```
安安说 [文本] [表情]
```

#### 参数说明

| 参数 | 说明     | 必填 | 可选值            |
|----|--------|----|----------------|
| 文本 | 要显示的内容 | 是  | 支持换行（使用 `\n`）  |
| 表情 | 安安的表情  | 否  | 害羞、生气、病娇、无语、开心 |

#### 命令别名

- `anan说`
- `anansays`

#### 使用示例

```
安安说 吾辈现在不想说话
```

```
安安说 吾辈命令你现在【猛击自己的魔丸一百下】 生气
```

```
安安说 第一行\n第二行\n第三行 害羞
```

#### 功能特性

- ✅ 支持多行文本（使用 `\n` 换行）
- ✅ 5种表情可选（害羞、生气、病娇、无语、开心）
- ✅ 自动适配文本长度
- ✅ 中文括号【】会被渲染成紫色

---

### 2. 审判表情包

生成审判时的选项图片，支持多行输入生成多个选项，所有选项合并在一张图片中。

#### 使用方法

```
【类型[:角色名]】文本
```

#### 参数说明

| 参数  | 说明    | 必填        | 可选值            |
|-----|-------|-----------|----------------|
| 类型  | 陈述类型  | 是         | 疑问、反驳、伪证、赞同、魔法 |
| 角色名 | 魔法角色名 | 否（魔法类型需填） | 详见下方列表         |
| 文本  | 选项内容  | 是         | 支持中文括号【】       |

#### 陈述类型

| 类型 | 英文         | 说明             |
|----|------------|----------------|
| 疑问 | Doubt      | 表示疑问的选项        |
| 反驳 | Refutation | 表示反驳的选项        |
| 伪证 | Perjury    | 表示伪证的选项        |
| 赞同 | Agreement  | 表示赞同的选项        |
| 魔法 | Magic      | 表示魔法的选项（需指定角色） |

#### 魔法角色列表

| 角色名 | 英文名     |
|-----|---------|
| 梅露露 | Meruru  |
| 诺亚  | Noah    |
| 汉娜  | Hannah  |
| 奈叶香 | Nanoha  |
| 亚里沙 | Arisa   |
| 米莉亚 | Miliya  |
| 雪莉  | Shirabe |
| 艾玛  | Ema     |
| 玛格  | Mago    |
| 安安  | Anan    |
| 可可  | Coco    |
| 希罗  | Hiro    |
| 蕾雅  | Lea     |

#### 魔法类型详细列表

| 中文名     | 英文名                  |
|---------|----------------------|
| 魔法：生命恢复 | Magic Chiyu & Saisei |
| 魔法：液体操控 | Magic Ekitai Sousa   |
| 魔法：悬浮   | Magic Fuyuu          |
| 魔法：原初   | Magic Genshi         |
| 魔法：白化   | Magic Hakka          |
| 魔法：替换   | Magic Irekawari      |
| 魔法：怪力   | Magic Kairiki        |
| 魔法：魔女杀  | Magic Majo Goroshi   |
| 魔法：模仿   | Magic Monomane       |
| 魔法：洗脑   | Magic Sennou         |
| 魔法：千里眼  | Magic Senrigan       |
| 魔法：死灵复生 | Magic Shini Modori   |
| 魔法：视线诱导 | Magic Shisen Yuudou  |

**注意**：魔法类型只需填写角色名即可，系统会自动匹配对应的魔法图标。

#### 使用示例

##### 单个选项

```
【伪证】我和艾玛不是恋人
```

##### 多个选项（推荐）

```
【伪证】我和艾玛不是恋人
【赞同】我们初中的时候就确认关系了
【魔法:诺亚】液体操控
```

##### 魔法类型（带冒号和空格）

```
【魔法: 诺亚】液体操控
【魔法：汉娜】空间操控
```

##### 带中文括号

```
【疑问】什么是【审判】？
【反驳】这根本不是【审判】！
```

#### 功能特性

- ✅ 支持多条选项输入（最多10条）
- ✅ 多条选项合并在一张图片中
- ✅ 4种基础陈述类型（疑问、反驳、伪证、赞同）
- ✅ 13种魔法类型（15个角色）
- ✅ 支持中文括号【】渲染为紫色
- ✅ 自动布局算法，确保选项均匀分布
- ✅ 角色切换功能（艾玛、希罗）

#### 选项数量建议

- **最佳效果**：1-3个选项
- **支持上限**：10个选项
- **最低要求**：1个选项

---

### 3. 切换角色

切换审判表情包中的说话角色，支持艾玛和希罗两种角色。角色选择会自动保存，重启后依然有效。

#### 使用方法

```
切换角色 [角色名]
```

#### 角色列表

| 角色名 | 英文名  |
|-----|------|
| 艾玛  | Ema  |
| 希罗  | Hiro |

#### 使用示例

```
切换角色 艾玛
```

```
切换角色 希罗
```

#### 功能特性

- ✅ 角色选择自动保存
- ✅ 重启后保持角色偏好
- ✅ 按用户/会话独立保存
- ✅ 支持角色名首尾空格自动去除

---

### 4. 帮助命令

显示插件的使用说明和帮助信息。

#### 使用方法

```
魔裁帮助
```

#### 命令别名

- `manosaba帮助`
- `魔裁help`

#### 功能特性

- ✅ 详细的命令说明
- ✅ 完整的参数列表
- ✅ 使用示例
- ✅ 小贴士提示

---

## 技术特性

### 安全性

- ✅ 路径遍历防护（表情和角色名白名单验证）
- ✅ 输入验证（文本长度、选项数量等）
- ✅ 异常处理（优雅的错误提示）

### 性能

- ✅ 异步图片生成（不阻塞主线程）
- ✅ 临时文件自动清理
- ✅ 高效的正则匹配

### 兼容性

- ✅ 支持多行消息输入
- ✅ 支持中英文冒号（`:` 和 `：`）
- ✅ 支持空格和换行符处理
- ✅ 跨平台路径处理

---

## 数据持久化

### 角色偏好存储

插件会自动保存用户的角色选择偏好：

- **存储位置**：`data/plugin_data/character_preferences.json`
- **存储格式**：JSON
- **作用范围**：按会话ID（session_id）独立保存
- **触发时机**：使用「切换角色」命令时自动保存

### 数据结构

```json
{
  "webchat!username!cid": "Ema",
  "qq!123456!987654": "Hiro"
}
```

---

## 常见问题

### Q1: 为什么我的审判表情包没有触发？

**A**: 请检查以下几点：
1. 确保使用了正确的格式：`【类型[:角色名]】文本`
2. 确保使用了中文方括号 `【】`，不是英文 `[]`
3. 确保类型名称正确（疑问、反驳、伪证、赞同、魔法）
4. 如果是魔法类型，确保角色名正确

### Q2: 最多支持多少个选项？

**A**: 最多支持 10 个选项。建议 1-3 个选项效果最佳。

### Q3: 如何在文本中换行？

**A**: 在文本中使用 `\n` 表示换行。例如：
```
安安说 第一行\n第二行\n第三行
```

### Q4: 中文括号会被特殊处理吗？

**A**: 是的，文本中的中文括号 `【】` 会被渲染成紫色，增强视觉效果。

### Q5: 角色选择会保存吗？

**A**: 会。使用「切换角色」命令后，角色选择会自动保存，重启 AstrBot 后依然有效。

### Q6: 魔法类型需要填写完整的魔法名称吗？

**A**: 不需要。只需填写角色名即可，系统会自动匹配对应的魔法图标。例如：
```
【魔法:诺亚】液体操控
```
会自动匹配到「魔法：液体操控」图标。

### Q7: 为什么安安说的表情无效？

**A**: 请确保表情名称正确且在白名单中。可选表情：害羞、生气、病娇、无语、开心。

---

## 错误处理

插件会针对以下情况返回友好的错误提示：

| 错误类型    | 错误提示                                                  |
|---------|-------------------------------------------------------|
| 无效的表情类型 | "Invalid face type: xxx. Must be one of [...]"        |
| 无效的陈述类型 | "无效的陈述类型: xxx"                                        |
| 无效的角色名  | "无效的角色名: xxx"                                         |
| 选项数量过多  | "选项数量过多，最多支持 10 个选项"                                  |
| 选项数量为空  | "请至少输入一个选项"                                           |
| 文本过长    | "text length exceeds maximum limit of 200 characters" |
| 文本为空    | "text cannot be empty or whitespace only"             |

---